<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buku Tamu Dinkes Kab. HSU</title>
  
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Custom CSS -->
  <style>
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none;
    }
    
    .sidebar {
      min-height: calc(100vh - 64px);
    }
  </style>
</head>
<body class="bg-gray-100">
  <!-- Header -->
  <header class="bg-blue-600 text-white shadow-md">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center">
        <h1 class="text-xl font-bold">Buku Tamu Dinas Kesehatan Kabupaten Hulu Sungai Utara</h1>
      </div>
      <button id="adminLoginBtn" class="bg-white text-blue-600 px-4 py-2 rounded-md hover:bg-blue-100 transition">
        <i class="fas fa-user-shield mr-2"></i>Admin
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    <!-- User Page -->
    <div id="userPage" class="block">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <!-- Statistik Card 1 -->
        <div class="bg-white rounded-lg shadow-md p-4">
          <div class="flex items-center">
            <div class="p-3 rounded-full bg-blue-100 text-blue-500">
              <i class="fas fa-users text-2xl"></i>
            </div>
            <div class="ml-3">
              <h3 class="text-gray-500 text-sm">Total Pengunjung</h3>
              <p id="totalTamu" class="text-xl font-semibold">0</p>
            </div>
          </div>
        </div>
        
        <!-- Statistik Card 2 -->
        <div class="bg-white rounded-lg shadow-md p-4">
          <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-100 text-green-500">
              <i class="fas fa-calendar-day text-2xl"></i>
            </div>
            <div class="ml-3">
              <h3 class="text-gray-500 text-sm">7 Hari Terakhir</h3>
              <p id="tamuHariIni" class="text-xl font-semibold">0</p>
            </div>
          </div>
        </div>
        
        <!-- Statistik Card 3 -->
        <div class="bg-white rounded-lg shadow-md p-4">
          <div class="flex items-center">
            <div class="p-3 rounded-full bg-purple-100 text-purple-500">
              <i class="fas fa-building text-2xl"></i>
            </div>
            <div class="ml-3">
              <h3 class="text-gray-500 text-sm">Mewakili Institusi</h3>
              <p id="tamuInstitusi" class="text-xl font-semibold">0</p>
            </div>
          </div>
        </div>
        
        <!-- Statistik Card 4 -->
        <div class="bg-white rounded-lg shadow-md p-4">
          <div class="flex items-center">
            <div class="p-3 rounded-full bg-yellow-100 text-yellow-500">
              <i class="fas fa-user text-2xl"></i>
            </div>
            <div class="ml-3">
              <h3 class="text-gray-500 text-sm">Perorangan</h3>
              <p id="tamuPerorangan" class="text-xl font-semibold">0</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Form Buku Tamu -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-semibold mb-6 text-gray-700">Form Buku Tamu</h2>
        <form id="formBukuTamu" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="nama" class="block text-gray-700 mb-2">Nama <span class="text-red-500">*</span></label>
              <input type="text" id="nama" name="nama" required class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label for="institusi" class="block text-gray-700 mb-2">Institusi/Asal <span class="text-red-500">*</span></label>
              <input type="text" id="institusi" name="institusi" required class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label for="jenisInstitusi" class="block text-gray-700 mb-2">Jenis Institusi <span class="text-red-500">*</span></label>
              <select id="jenisInstitusi" name="jenisInstitusi" required class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Pilih Jenis</option>
                <option value="Perorangan">Perorangan</option>
                <option value="Mewakili Institusi">Mewakili Institusi</option>
              </select>
            </div>
            
            <div>
              <label for="keperluan" class="block text-gray-700 mb-2">Keperluan <span class="text-red-500">*</span></label>
              <input type="text" id="keperluan" name="keperluan" required class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label for="email" class="block text-gray-700 mb-2">Email (Opsional)</label>
              <input type="email" id="email" name="email" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label for="telepon" class="block text-gray-700 mb-2">Nomor Telepon (Opsional)</label>
              <input type="tel" id="telepon" name="telepon" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
          </div>
          
          <div>
            <label for="catatan" class="block text-gray-700 mb-2">Catatan Tambahan (Opsional)</label>
            <textarea id="catatan" name="catatan" rows="3" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
          
          <div class="flex justify-end">
            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition">
              <i class="fas fa-save mr-2"></i>Simpan
            </button>
          </div>
        </form>
      </div>
      
      <!-- Recent Visitors for User Page -->
      <div class="bg-white rounded-lg shadow-md p-6 mt-6">
        <h3 class="text-xl font-semibold mb-4 text-gray-700">Pengunjung Terbaru</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white">
            <thead>
              <tr>
                <th class="py-2 px-4 border-b text-left">Tanggal</th>
                <th class="py-2 px-4 border-b text-left">Nama</th>
                <th class="py-2 px-4 border-b text-left">Institusi</th>
                <th class="py-2 px-4 border-b text-left">Keperluan</th>
              </tr>
            </thead>
            <tbody id="userRecentVisitorsTable">
              <!-- Data will be populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-gray-700">Login Admin</h2>
          <button id="closeLoginModal" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <form id="formLogin" class="space-y-4">
          <div>
            <label for="username" class="block text-gray-700 mb-2">Username</label>
            <input type="text" id="username" name="username" required class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label for="password" class="block text-gray-700 mb-2">Password</label>
            <input type="password" id="password" name="password" required class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div class="flex justify-end">
            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition">
              <i class="fas fa-sign-in-alt mr-2"></i>Login
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Admin Page -->
    <div id="adminPage" class="hidden">
      <div class="flex">
        <!-- Sidebar -->
        <div class="sidebar w-64 bg-gray-800 text-white p-4">
          <div class="mb-8">
            <h2 class="text-xl font-semibold mb-2">Admin Panel</h2>
            <p id="adminName" class="text-gray-400">Selamat datang, Admin</p>
          </div>
          
          <nav class="space-y-2">
            <a href="#" id="navDashboard" class="block py-2 px-4 rounded hover:bg-gray-700 bg-gray-700">
              <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
            </a>
            <a href="#" id="navDaftarTamu" class="block py-2 px-4 rounded hover:bg-gray-700">
              <i class="fas fa-users mr-2"></i>Daftar Tamu
            </a>
            <a href="#" id="navTambahTamu" class="block py-2 px-4 rounded hover:bg-gray-700">
              <i class="fas fa-user-plus mr-2"></i>Tambah Tamu
            </a>
            <a href="#" id="navLogout" class="block py-2 px-4 rounded hover:bg-gray-700 mt-8 text-red-400">
              <i class="fas fa-sign-out-alt mr-2"></i>Logout
            </a>
          </nav>
        </div>
        
        <!-- Content -->
        <div class="flex-1 p-8">
          <!-- Admin Dashboard -->
          <div id="adminDashboard" class="block">
            <h2 class="text-2xl font-semibold mb-6 text-gray-700">Dashboard</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
              <!-- Statistik Card 1 -->
              <div class="bg-white rounded-lg shadow-md p-4">
                <div class="flex items-center">
                  <div class="p-3 rounded-full bg-blue-100 text-blue-500">
                    <i class="fas fa-users text-2xl"></i>
                  </div>
                  <div class="ml-3">
                    <h3 class="text-gray-500 text-sm">Total Pengunjung</h3>
                    <p id="adminTotalTamu" class="text-xl font-semibold">0</p>
                  </div>
                </div>
              </div>
              
              <!-- Statistik Card 2 -->
              <div class="bg-white rounded-lg shadow-md p-4">
                <div class="flex items-center">
                  <div class="p-3 rounded-full bg-green-100 text-green-500">
                    <i class="fas fa-calendar-day text-2xl"></i>
                  </div>
                  <div class="ml-3">
                    <h3 class="text-gray-500 text-sm">7 Hari Terakhir</h3>
                    <p id="adminTamuHariIni" class="text-xl font-semibold">0</p>
                  </div>
                </div>
              </div>
              
              <!-- Statistik Card 3 -->
              <div class="bg-white rounded-lg shadow-md p-4">
                <div class="flex items-center">
                  <div class="p-3 rounded-full bg-purple-100 text-purple-500">
                    <i class="fas fa-building text-2xl"></i>
                  </div>
                  <div class="ml-3">
                    <h3 class="text-gray-500 text-sm">Mewakili Institusi</h3>
                    <p id="adminTamuInstitusi" class="text-xl font-semibold">0</p>
                  </div>
                </div>
              </div>
              
              <!-- Statistik Card 4 -->
              <div class="bg-white rounded-lg shadow-md p-4">
                <div class="flex items-center">
                  <div class="p-3 rounded-full bg-yellow-100 text-yellow-500">
                    <i class="fas fa-user text-2xl"></i>
                  </div>
                  <div class="ml-3">
                    <h3 class="text-gray-500 text-sm">Perorangan</h3>
                    <p id="adminTamuPerorangan" class="text-xl font-semibold">0</p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Recent Visitors -->
            <div class="bg-white rounded-lg shadow-md p-6">
              <h3 class="text-xl font-semibold mb-4 text-gray-700">Pengunjung Terbaru</h3>
              <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                  <thead>
                    <tr>
                      <th class="py-2 px-4 border-b text-left">Tanggal</th>
                      <th class="py-2 px-4 border-b text-left">Nama</th>
                      <th class="py-2 px-4 border-b text-left">Institusi</th>
                      <th class="py-2 px-4 border-b text-left">Keperluan</th>
                    </tr>
                  </thead>
                  <tbody id="recentVisitorsTable">
                    <!-- Data will be populated by JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <!-- Daftar Tamu -->
          <div id="adminDaftarTamu" class="hidden">
            <h2 class="text-2xl font-semibold mb-6 text-gray-700">Daftar Tamu</h2>
            
            <div class="bg-white rounded-lg shadow-md p-6">
              <div class="mb-4 flex justify-between items-center">
                <input type="text" id="searchTamu" placeholder="Cari tamu..." class="px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              
              <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                  <thead>
                    <tr>
                      <th class="py-2 px-4 border-b text-left">Tanggal</th>
                      <th class="py-2 px-4 border-b text-left">Nama</th>
                      <th class="py-2 px-4 border-b text-left">Institusi</th>
                      <th class="py-2 px-4 border-b text-left">Jenis</th>
                      <th class="py-2 px-4 border-b text-left">Keperluan</th>
                      <th class="py-2 px-4 border-b text-left">Kontak</th>
                      <th class="py-2 px-4 border-b text-left">Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="daftarTamuTable">
                    <!-- Data will be populated by JavaScript -->
                  </tbody>
                </table>
              </div>
              
              <!-- Pagination Controls -->
              <div class="mt-4 flex justify-between items-center">
                <div>
                  <span id="paginationInfo" class="text-sm text-gray-600">Menampilkan 1-10 dari 0 tamu</span>
                </div>
                <div class="flex space-x-2">
                  <button id="prevPageBtn" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-chevron-left"></i>
                  </button>
                  <button id="nextPageBtn" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Tambah Tamu -->
          <div id="adminTambahTamu" class="hidden">
            <h2 class="text-2xl font-semibold mb-6 text-gray-700">Tambah Tamu</h2>
            
            <div class="bg-white rounded-lg shadow-md p-6">
              <form id="formAdminTambahTamu" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label for="adminNama" class="block text-gray-700 mb-2">Nama <span class="text-red-500">*</span></label>
                    <input type="text" id="adminNama" name="nama" required class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  </div>
                  
                  <div>
                    <label for="adminInstitusi" class="block text-gray-700 mb-2">Institusi/Asal <span class="text-red-500">*</span></label>
                    <input type="text" id="adminInstitusi" name="institusi" required class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  </div>
                  
                  <div>
                    <label for="adminJenisInstitusi" class="block text-gray-700 mb-2">Jenis Institusi <span class="text-red-500">*</span></label>
                    <select id="adminJenisInstitusi" name="jenisInstitusi" required class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                      <option value="">Pilih Jenis</option>
                      <option value="Perorangan">Perorangan</option>
                      <option value="Mewakili Institusi">Mewakili Institusi</option>
                    </select>
                  </div>
                  
                  <div>
                    <label for="adminKeperluan" class="block text-gray-700 mb-2">Keperluan <span class="text-red-500">*</span></label>
                    <input type="text" id="adminKeperluan" name="keperluan" required class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  </div>
                  
                  <div>
                    <label for="adminEmail" class="block text-gray-700 mb-2">Email (Opsional)</label>
                    <input type="email" id="adminEmail" name="email" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  </div>
                  
                  <div>
                    <label for="adminTelepon" class="block text-gray-700 mb-2">Nomor Telepon (Opsional)</label>
                    <input type="tel" id="adminTelepon" name="telepon" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  </div>
                </div>
                
                <div>
                  <label for="adminCatatan" class="block text-gray-700 mb-2">Catatan Tambahan (Opsional)</label>
                  <textarea id="adminCatatan" name="catatan" rows="3" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                <div class="flex justify-end">
                  <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition">
                    <i class="fas fa-save mr-2"></i>Simpan
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white py-4">
    <div class="container mx-auto px-4 text-center">
      <p>&copy; 2025 Dinas Kesehatan Kabupaten Hulu Sungai Utara. All rights reserved.</p>
      </div>
    </footer>
  
    <!-- Alert Modal -->
    <div id="alertModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
        <div class="text-center">
          <div id="alertIcon" class="mx-auto mb-4 text-4xl"></div>
          <h3 id="alertTitle" class="text-lg font-medium text-gray-900 mb-2"></h3>
          <div id="alertMessage" class="text-sm text-gray-500"></div>
          <div class="mt-4">
            <button id="alertOkButton" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
              OK
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="loader"></div>
  </div>

  <!-- JavaScript -->
  <script>
    // Global variables
    let adminData = null;
    let allTamuData = [];
    let currentPage = 1;
    let itemsPerPage = 10;
    let filteredData = [];
    
    // DOM Elements
    const userPage = document.getElementById('userPage');
    const adminPage = document.getElementById('adminPage');
    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const adminLoginModal = document.getElementById('adminLoginModal');
    const closeLoginModal = document.getElementById('closeLoginModal');
    const formLogin = document.getElementById('formLogin');
    const formBukuTamu = document.getElementById('formBukuTamu');
    const formAdminTambahTamu = document.getElementById('formAdminTambahTamu');
    const adminName = document.getElementById('adminName');
    const navDashboard = document.getElementById('navDashboard');
    const navDaftarTamu = document.getElementById('navDaftarTamu');
    const navTambahTamu = document.getElementById('navTambahTamu');
    const navLogout = document.getElementById('navLogout');
    const adminDashboard = document.getElementById('adminDashboard');
    const adminDaftarTamu = document.getElementById('adminDaftarTamu');
    const adminTambahTamu = document.getElementById('adminTambahTamu');
    const searchTamu = document.getElementById('searchTamu');
    const daftarTamuTable = document.getElementById('daftarTamuTable');
    const recentVisitorsTable = document.getElementById('recentVisitorsTable');
    const alertModal = document.getElementById('alertModal');
    const alertIcon = document.getElementById('alertIcon');
    const alertTitle = document.getElementById('alertTitle');
    const alertMessage = document.getElementById('alertMessage');
    const alertOkButton = document.getElementById('alertOkButton');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const prevPageBtn = document.getElementById('prevPageBtn');
    const nextPageBtn = document.getElementById('nextPageBtn');
    const paginationInfo = document.getElementById('paginationInfo');
    
    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      // Setup Google Sheet if needed
      google.script.run
        .withSuccessHandler(function(response) {
          console.log('Setup response:', response);
        })
        .withFailureHandler(function(error) {
          console.error('Setup error:', error);
        })
        .setupSheet();
      
      // Load statistics for user page
      loadStatistics();
      
      // Load recent visitors for user page
      loadRecentVisitorsForUser();
    });
    
    // Show loading spinner
    function showLoading() {
      loadingSpinner.classList.remove('hidden');
    }
    
    // Load recent visitors for user page
    function loadRecentVisitorsForUser() {
      showLoading();
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            const recentTamu = response.data.sort((a, b) => {
              return new Date(b['Tanggal']) - new Date(a['Tanggal']);
            }).slice(0, 5);
            
            const userRecentVisitorsTable = document.getElementById('userRecentVisitorsTable');
            userRecentVisitorsTable.innerHTML = '';
            
            if (recentTamu.length === 0) {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td colspan="4" class="py-4 text-center text-gray-500">Belum ada data pengunjung</td>
              `;
              userRecentVisitorsTable.appendChild(row);
            } else {
              recentTamu.forEach(function(tamu) {
                const row = document.createElement('tr');
                row.innerHTML = `
                  <td class="py-2 px-4 border-b">${tamu['Tanggal']}</td>
                  <td class="py-2 px-4 border-b">${tamu['Nama']}</td>
                  <td class="py-2 px-4 border-b">${tamu['Institusi/Asal']}</td>
                  <td class="py-2 px-4 border-b">${tamu['Keperluan']}</td>
                `;
                userRecentVisitorsTable.appendChild(row);
              });
            }
          } else {
            console.error('Error loading recent visitors:', response.message);
          }
          hideLoading();
        })
        .withFailureHandler(function(error) {
          console.error('Error loading recent visitors:', error);
          hideLoading();
        })
        .getAllTamu();
    }
    
    // Hide loading spinner
    function hideLoading() {
      loadingSpinner.classList.add('hidden');
    }
    
    // Show alert modal
    function showAlert(type, title, message) {
      if (type === 'success') {
        alertIcon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
      } else if (type === 'error') {
        alertIcon.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
      } else if (type === 'warning') {
        alertIcon.innerHTML = '<i class="fas fa-exclamation-triangle text-yellow-500"></i>';
      } else {
        alertIcon.innerHTML = '<i class="fas fa-info-circle text-blue-500"></i>';
      }
      
      alertTitle.textContent = title;
      alertMessage.textContent = message;
      alertModal.classList.remove('hidden');
    }
    
    // Close alert modal
    alertOkButton.addEventListener('click', function() {
      alertModal.classList.add('hidden');
    });
    
    // Load statistics
    function loadStatistics() {
      showLoading();
      google.script.run
        .withSuccessHandler(function(response) {
          try {
            if (response.success) {
              // Update user page statistics
              const totalTamuEl = document.getElementById('totalTamu');
              const tamuHariIniEl = document.getElementById('tamuHariIni');
              const tamuInstitusiEl = document.getElementById('tamuInstitusi');
              const tamuPeroranganEl = document.getElementById('tamuPerorangan');
              
              if (totalTamuEl) totalTamuEl.textContent = response.totalTamu;
              if (tamuHariIniEl) tamuHariIniEl.textContent = response.tamuMingguIni;
              if (tamuInstitusiEl) tamuInstitusiEl.textContent = response.jenisInstitusi.institusi;
              if (tamuPeroranganEl) tamuPeroranganEl.textContent = response.jenisInstitusi.perorangan;
              
              // Update admin page statistics if admin is logged in
              if (adminData) {
                const adminTotalTamuEl = document.getElementById('adminTotalTamu');
                const adminTamuHariIniEl = document.getElementById('adminTamuHariIni');
                const adminTamuInstitusiEl = document.getElementById('adminTamuInstitusi');
                const adminTamuPeroranganEl = document.getElementById('adminTamuPerorangan');
                
                if (adminTotalTamuEl) adminTotalTamuEl.textContent = response.totalTamu;
                if (adminTamuHariIniEl) adminTamuHariIniEl.textContent = response.tamuMingguIni;
                if (adminTamuInstitusiEl) adminTamuInstitusiEl.textContent = response.jenisInstitusi.institusi;
                if (adminTamuPeroranganEl) adminTamuPeroranganEl.textContent = response.jenisInstitusi.perorangan;
              }
            } else {
              showAlert('error', 'Error', response.message);
            }
          } catch (err) {
            console.error('Error updating statistics:', err);
            showAlert('error', 'Error', 'Terjadi kesalahan saat memperbarui statistik.');
          } finally {
            hideLoading();
          }
        })
        .withFailureHandler(function(error) {
          showAlert('error', 'Error', error.toString());
          hideLoading();
        })
        .getStatistik();
    }
    
    // Load all tamu data
    function loadAllTamu() {
      showLoading();
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            allTamuData = response.data;
            filteredData = [...allTamuData]; // Initialize filtered data with all data
            currentPage = 1; // Reset to first page when loading new data
            
            // Update daftar tamu table with pagination
            updateDaftarTamuTable(filteredData);
            
            // Update recent visitors table (show only 5 most recent)
            const recentTamu = [...allTamuData].sort((a, b) => {
              return new Date(b['Tanggal']) - new Date(a['Tanggal']);
            }).slice(0, 5);
            
            recentVisitorsTable.innerHTML = '';
            recentTamu.forEach(function(tamu) {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td class="py-2 px-4 border-b">${tamu['Tanggal']}</td>
                <td class="py-2 px-4 border-b">${tamu['Nama']}</td>
                <td class="py-2 px-4 border-b">${tamu['Institusi/Asal']}</td>
                <td class="py-2 px-4 border-b">${tamu['Keperluan']}</td>
              `;
              recentVisitorsTable.appendChild(row);
            });
          } else {
            showAlert('error', 'Error', response.message);
          }
          hideLoading();
        })
        .withFailureHandler(function(error) {
          showAlert('error', 'Error', error.toString());
          hideLoading();
        })
        .getAllTamu();
    }
    
    // Update daftar tamu table with pagination
    function updateDaftarTamuTable(data) {
      daftarTamuTable.innerHTML = '';
      
      if (data.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="7" class="py-4 text-center text-gray-500">Tidak ada data tamu</td>
        `;
        daftarTamuTable.appendChild(row);
        
        // Update pagination info and disable buttons
        paginationInfo.textContent = `Menampilkan 0-0 dari 0 tamu`;
        prevPageBtn.disabled = true;
        nextPageBtn.disabled = true;
        return;
      }
      
      // Calculate pagination values
      const totalPages = Math.ceil(data.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, data.length);
      
      // Get current page data
      const currentPageData = data.slice(startIndex, endIndex);
      
      // Populate table with current page data
      currentPageData.forEach(function(tamu) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="py-2 px-4 border-b">${tamu['Tanggal']}</td>
          <td class="py-2 px-4 border-b">${tamu['Nama']}</td>
          <td class="py-2 px-4 border-b">${tamu['Institusi/Asal']}</td>
          <td class="py-2 px-4 border-b">${tamu['Jenis Institusi']}</td>
          <td class="py-2 px-4 border-b">${tamu['Keperluan']}</td>
          <td class="py-2 px-4 border-b">
            ${tamu['Email'] !== '-' ? `<div>Email: ${tamu['Email']}</div>` : ''}
            ${tamu['Nomor Telepon'] !== '-' ? `<div>Telp: ${tamu['Nomor Telepon']}</div>` : ''}
          </td>
          <td class="py-2 px-4 border-b">
            <button class="text-red-500 hover:text-red-700" onclick="hapusTamu('${tamu['ID']}')">
              <i class="fas fa-trash"></i> Hapus
            </button>
          </td>
        `;
        daftarTamuTable.appendChild(row);
      });
      
      // Update pagination info
      paginationInfo.textContent = `Menampilkan ${startIndex + 1}-${endIndex} dari ${data.length} tamu`;
      
      // Update pagination button states
      prevPageBtn.disabled = currentPage === 1;
      nextPageBtn.disabled = currentPage === totalPages;
    }
    
    // Search tamu with pagination
    searchTamu.addEventListener('input', function() {
      const searchValue = this.value.toLowerCase();
      
      if (searchValue === '') {
        filteredData = [...allTamuData];
      } else {
        filteredData = allTamuData.filter(function(tamu) {
          return (
            tamu['Nama'].toLowerCase().includes(searchValue) ||
            tamu['Institusi/Asal'].toLowerCase().includes(searchValue) ||
            tamu['Keperluan'].toLowerCase().includes(searchValue)
          );
        });
      }
      
      // Reset to first page when search changes
      currentPage = 1;
      updateDaftarTamuTable(filteredData);
    });
    
    // Pagination event listeners
    prevPageBtn.addEventListener('click', function() {
      if (currentPage > 1) {
        currentPage--;
        updateDaftarTamuTable(filteredData);
      }
    });
    
    nextPageBtn.addEventListener('click', function() {
      const totalPages = Math.ceil(filteredData.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        updateDaftarTamuTable(filteredData);
      }
    });
    
    // Form Buku Tamu Submit
    formBukuTamu.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = {
        nama: document.getElementById('nama').value,
        institusi: document.getElementById('institusi').value,
        jenisInstitusi: document.getElementById('jenisInstitusi').value,
        keperluan: document.getElementById('keperluan').value,
        email: document.getElementById('email').value,
        telepon: document.getElementById('telepon').value,
        catatan: document.getElementById('catatan').value
      };
      
      showLoading();
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            showAlert('success', 'Sukses', response.message);
            formBukuTamu.reset();
            loadStatistics();
            loadRecentVisitorsForUser(); // Refresh recent visitors table
          } else {
            showAlert('error', 'Error', response.message);
          }
          hideLoading();
        })
        .withFailureHandler(function(error) {
          showAlert('error', 'Error', error.toString());
          hideLoading();
        })
        .tambahTamu(formData);
    });
    
    // Form Admin Tambah Tamu Submit
    formAdminTambahTamu.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = {
        nama: document.getElementById('adminNama').value,
        institusi: document.getElementById('adminInstitusi').value,
        jenisInstitusi: document.getElementById('adminJenisInstitusi').value,
        keperluan: document.getElementById('adminKeperluan').value,
        email: document.getElementById('adminEmail').value,
        telepon: document.getElementById('adminTelepon').value,
        catatan: document.getElementById('adminCatatan').value
      };
      
      showLoading();
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            showAlert('success', 'Sukses', response.message);
            formAdminTambahTamu.reset();
            loadAllTamu();
            loadStatistics();
          } else {
            showAlert('error', 'Error', response.message);
          }
          hideLoading();
        })
        .withFailureHandler(function(error) {
          showAlert('error', 'Error', error.toString());
          hideLoading();
        })
        .tambahTamu(formData);
    });
    
    // Admin Login Button Click
    adminLoginBtn.addEventListener('click', function() {
      adminLoginModal.classList.remove('hidden');
    });
    
    // Close Login Modal
    closeLoginModal.addEventListener('click', function() {
      adminLoginModal.classList.add('hidden');
    });
    
    // Form Login Submit
    formLogin.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      showLoading();
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            adminData = response.admin;
            adminName.textContent = `Selamat datang, ${adminData.nama}`;
            
            // Hide login modal and user page, show admin page
            adminLoginModal.classList.add('hidden');
            userPage.classList.add('hidden');
            adminPage.classList.remove('hidden');
            
            // Load admin data
            loadAllTamu();
            loadStatistics();
            
            // Reset form
            formLogin.reset();
          } else {
            // Show error notification for failed login
            showAlert('error', 'Login Gagal', response.message || 'Username atau password tidak valid');
          }
          hideLoading();
        })
        .withFailureHandler(function(error) {
          showAlert('error', 'Error', 'Terjadi kesalahan saat login. Silakan coba lagi.');
          console.error('Login error:', error);
          hideLoading();
        })
        .loginAdmin(username, password);
    });
    
    // Admin Navigation
    navDashboard.addEventListener('click', function(e) {
      e.preventDefault();
      showAdminPage('dashboard');
    });
    
    navDaftarTamu.addEventListener('click', function(e) {
      e.preventDefault();
      showAdminPage('daftarTamu');
    });
    
    navTambahTamu.addEventListener('click', function(e) {
      e.preventDefault();
      showAdminPage('tambahTamu');
    });
    
    navLogout.addEventListener('click', function(e) {
      e.preventDefault();
      adminData = null;
      adminPage.classList.add('hidden');
      userPage.classList.remove('hidden');
    });
    
    // Show admin page section
    function showAdminPage(section) {
      // Hide all sections
      adminDashboard.classList.add('hidden');
      adminDaftarTamu.classList.add('hidden');
      adminTambahTamu.classList.add('hidden');
      
      // Remove active class from all nav items
      navDashboard.classList.remove('bg-gray-700');
      navDaftarTamu.classList.remove('bg-gray-700');
      navTambahTamu.classList.remove('bg-gray-700');
      
      // Show selected section and highlight nav item
      if (section === 'dashboard') {
        adminDashboard.classList.remove('hidden');
        navDashboard.classList.add('bg-gray-700');
      } else if (section === 'daftarTamu') {
        adminDaftarTamu.classList.remove('hidden');
        navDaftarTamu.classList.add('bg-gray-700');
      } else if (section === 'tambahTamu') {
        adminTambahTamu.classList.remove('hidden');
        navTambahTamu.classList.add('bg-gray-700');
      }
    }
  </script>
</body>
</html>
